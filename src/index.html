<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Constrained Particle Dynamics</title>
    <style>
        /* fonts: */
        @font-face {
            font-family: "OCR-A";
            src: url("/assets/fonts/OCR-a___.woff") format("woff");
        }

        @font-face {
            font-family: "basis33";
            src: url("/assets/fonts/basis33.ttf") format("truetype");
        }

        @font-face {
            font-family: "QuinqueFive";
            src: url("/assets/fonts/QuinqueFive.ttf") format("truetype");
        }

        body {
            background-color: #0e1012;
        }

        #engineCanvas {
            /* position: absolute; */
            /* top: 0; */
            /* left: 0; */
            /* z-index: 0; */
            display: block;
            margin: 8px auto 0 auto;
        }

        /* Make the whole window semi-transparent */
        .mod-debug-window {
            position: absolute;
            border: 2px solid #ffffff;
            background-color: #0c0e11;
            opacity: 0.9;
            /* width: 300px; */
            padding: 5px;
            border-radius: 1px;
            border-width: 1px;
            cursor: default;
            display: none;
            /* Start hidden */

            font-family: basis33;
            user-select: none;
        }

        /* Keep the header fully opaque */
        .mod-debug-header {
            /* background-color: #1d1d1f; */
            background-color: #3d85e1;
            padding: 8px;
            height: 5px;
            font-size: 10px;
            color: white;
            display: flex;
            border: none;
            justify-content: space-between;
            /* justify-content: right; */
            align-items: center;
            cursor: move;
            opacity: 1;
            font-family: QuinqueFive;
            text-align: center;
            /* Fully opaque */
        }

        /* Close button */
        .mod-close-button {
            margin-left: auto;
            cursor: pointer;
            color: white;
            font-size: 14px;
        }

        .mod-close-button:hover {
            color: #888;
        }

        .mod-reset-button {
            cursor: pointer;
            color: #fff;
            font-size: 8px;
            margin-left: auto;
            margin-left: 20%;
            margin-right: 0px;
        }

        .mod-reset-button:hover {
            color: #888;
        }

        /* Labels */
        .mod-label {
            margin-top: 5px;
            margin-bottom: 2px;
            color: #ffffff;
            font-size: 15px;
            opacity: 1;
            /* Fully opaque */
            margin-left: 3px;
        }

        .mod-label p {
            margin-top: 3px;
            margin-bottom: 3px; 
        }

        .mod-graph-canvas {
            display: none;
            align-items: center;
            width: 200px;
            height: 150px;
            border: 1px solid white;
        }

        .mod-graph-toggle-button {
            cursor: pointer;
            color: white;
            font-size: 14px;
        }

        .mod-graph-toggle-button:hover a{
            color: #888;
        }

        /* Slider styles */
        .mod-slider-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* background-color: #2d4b75; */
            /* padding: 5px; */
            border-radius: 3px;
            margin-bottom: 5px;
            opacity: 1;
            /* Fully opaque */
        }

        .mod-slider-label {
            color: #fff;
            font-size: 15px;
        }

        .mod-slider {
            appearance: none;
            margin-right: 5px;
            width: 100%;
            height: 15px;
            /* background: #1d1d1f; */
            background: #21324e;
            outline: none;
            opacity: 1;
        }

        .mod-slider:hover {
            /* background-color: #35373b; */
            background-color: #314b75;
        }

        .mod-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px;
            height: 12px;
            /* background-color: #ffffff; */
            background-color: #3d85e1;
            border-radius: 0%;
            cursor: pointer;
        }

        /* Checkbox styles */
        .mod-checkbox-label {
            appearance: none;
            display: flex;
            align-items: center;
            font-size: 15px;
            margin-bottom: 0px;
            color: #ffffff;
        }

        .mod-checkbox-label input {
            appearance: none;
            margin-right: 8px;
            width: 14px;
            height: 14px;
            /* background-color: #1d1d1f; */
            background-color: #21324e;
            border: 1px solid #ffffff;
            cursor: pointer;
        }

        input[type="checkbox"]:checked {
            /* background-color: #ffffff; */
            background-color: #3d85e1;
        }

        .mod-button-label {
            appearance: none;
            display: flex;
            align-items: center;
            font-size: 15px;
            margin-bottom: 2px;
            color: #ffffff;

            user-select: none;
        }

        .mod-button-label input {
            appearance: none;
            margin-right: 8px;
            width: 14px;
            height: 14px;
            /* background-color: #1d1d1f; */
            background-color: #21324e;
            border: 1px solid #ffffff;
            cursor: pointer;
        }

        .top-left-label {
            position: absolute;
            font-family: QuinqueFive;
            font-size: 10px;
            color: #fff;

            margin-left: 3px;
            margin-top: 3px;
        }

    </style>
</head>

<body>

    <!-- top left text showing primitive keybinds -->
    <p class="top-left-label">[q][a][z][w]</p>

    <!-- Debug window -->
    <div id="mod-settings-window" class="mod-debug-window" style="width: 300px">
        <!-- Header with Close Button -->
        <div id="mod-settings-header" class="mod-debug-header">
            <span>// SETTINGS </span>
            <span id="settings-reset-button" class="mod-reset-button">r</span>
            <span id="settings-close-button" class="mod-close-button">✕</span>
        </div>

        <!-- Gravity Slider -->
        <div class="mod-label">Gravity</div>
        <div class="mod-slider-container">
            <input id="settings-gravity-slider" class="mod-slider" type="range" min="-10" max="10" step="0.01"
                value="8">
            <div id="settings-gravity-value" class="mod-slider-label">8</div>
        </div>

        <!-- Linear Damping Slider -->
        <div class="mod-label">Linear Damping</div>
        <div class="mod-slider-container">
            <input id="settings-linear-damping-slider" class="mod-slider" type="range" min="0" max="5" step="0.005"
                value="0.4">
            <div id="settings-linear-damping-value" class="mod-slider-label">0.4</div>
        </div>

        <!-- Mouse Spring Slider -->
        <div class="mod-label">Mouse Spring Stiffness</div>
        <div class="mod-slider-container">
            <input id="settings-mouse-spring-slider" class="mod-slider" type="range" min="0" max="200" step="0.01"
                value="100">
            <div id="settings-mouse-spring-value" class="mod-slider-label">100</div>
        </div>

        <!-- Spring Joint Slider -->
        <div class="mod-label">Spring Joint Stiffness</div>
        <div class="mod-slider-container">
            <input id="settings-spring-joint-slider" class="mod-slider" type="range" min="0" max="300" step="1"
                value="100">
            <div id="settings-spring-joint-value" class="mod-slider-label">100</div>
        </div>

        <!-- Omega Constraint Slider -->
        <div class="mod-label">Rotation Velocity Const.</div>
        <div class="mod-slider-container">
            <input id="settings-omega-constraint-slider" class="mod-slider" type="range" min="0" max="150" step="0.1"
                value="90">
            <div id="settings-omega-constraint-value" class="mod-slider-label">90</div>
        </div>

        <!-- Lagrange Mult (strain) Slider -->
        <div class="mod-label">Maximum strain (10^)</div>
        <div class="mod-slider-container">
            <input id="settings-lagrange-limit-slider" class="mod-slider" type="range" min="0" max="10" step="0.01"
                value="8">
            <div id="settings-lagrange-limit-value" class="mod-slider-label">8</div>
        </div>

        <!-- Rendering Checkbox -->
        <!-- <label class="mod-checkbox-label"> -->
        <!-- <input id="mod-rendering-checkbox" type="checkbox" checked> -->
        <!-- Rendering -->
        <!-- </label> -->

    </div>

    <div id="profiling-window" class="mod-debug-window" style="width: 220px">
        <div id="mod-profiling-header" class="mod-debug-header">
            // PROFILING
            <span id="profiling-close-button" class="mod-close-button">✕</span>
        </div>

        <div class="mod-label">
            <p> <span id="system-dt-graph-toggle-button" class="mod-graph-toggle-button">+</span> SYSTEM DT = <span id="system-dt">0.000</span> MS </p>
            <canvas id="system-dt-graph-canvas" class="mod-graph-canvas"></canvas>
            
            <p> <span id="system-pdt-graph-toggle-button" class="mod-graph-toggle-button">+</span> PDT = <span id="system-pdt">0.000</span> MS </p>
            <canvas id="system-pdt-graph-canvas" class="mod-graph-canvas"></canvas>
            
            <p> <span id="system-rdt-graph-toggle-button" class="mod-graph-toggle-button">+</span> RDT = <span id="system-rdt">0.000</span> MS </p>
            <canvas id="system-rdt-graph-canvas" class="mod-graph-canvas"></canvas>
            
            <p> <span id="system-cfsdt-graph-toggle-button" class="mod-graph-toggle-button">+</span> CFS DT = <span id="system-cfsdt">0.000</span> MS </p>
            <canvas id="system-cfsdt-graph-canvas" class="mod-graph-canvas"></canvas>

            <p> CFS ERR = <span id="system-cfs-err">0.000</span> </p>
           
            <p> <span id="system-energy-graph-toggle-button" class="mod-graph-toggle-button">+</span> ENERGY = <span id="system-energy">0.000</span> </p> 
            <canvas id="system-energy-graph-canvas" class="mod-graph-canvas"></canvas>
            
            <p> <span id="system-c-eval-graph-toggle-button" class="mod-graph-toggle-button">+</span> C-EVAL = <span id="system-c-eval">0.000</span> </p>
            <canvas id="system-c-eval-graph-canvas" class="mod-graph-canvas"></canvas>
            
            <p> <span id="system-c-dot-eval-graph-toggle-button" class="mod-graph-toggle-button">+</span> C-DOT-EVAL = <span id="system-c-dot-eval">0.000</span> </p>
            <canvas id="system-c-dot-eval-graph-canvas" class="mod-graph-canvas"></canvas>
            
        </div>
    </div>

    <div id="info-window" class="mod-debug-window" style="width: 220px">
        <div id="mod-info-header" class="mod-debug-header">
            // INFO
            <span id="info-close-button" class="mod-close-button">✕</span>
        </div>

        <div class="mod-label">
            <p> // GENERAL INFO </p>
            <p> SIMULATING = <span id="system-simulating">FALSE</span> </p>
            <p> FR = <span id="system-fr">0.000</span> FPS </p>
            <p> SR = <span id="system-sr">0.000</span> HZ </p>
            <p> STEPS = <span id="system-steps">0.000</span> </p>
            <p> &nbsp </p>
            <p> // PHYSICS INFO </p>
            <p> NUM MASS OBJECTS = <span id="physics-mass-objects">0.000</span> </p>
            <p> NUM FORCEGENERATORS = <span id="physics-force-generators">0.000</span> </p>
            <p> NUM CONSTRAINTS = <span id="physics-constraints">0.000</span> </p>
            <p> &nbsp </p>
        </div>

        <div class="mod-label">
            <p> // SAVED PHYSICS STATES <span id="info-reset-saved-states-button" class="mod-reset-button" style="font-size: 15px;">R</span> </p>
        </div>

        <label class="mod-button-label">
            <input id="info-saved-state-1-button" type="button">
            State 1
        </label>
        <label class="mod-button-label">
            <input id="info-saved-state-2-button" type="button">
            State 2
        </label>
        <label class="mod-button-label">
            <input id="info-saved-state-3-button" type="button">
            State 3
        </label>
        <label class="mod-button-label">
            <input id="info-saved-state-4-button" type="button">
            State 4
        </label>

    </div>

    <div id="keybinds-window" class="mod-debug-window" style="width: 300px">
        <div id="mod-keybinds-header" class="mod-debug-header">
            // KEYBINDS
            <span id="keybinds-close-button" class="mod-close-button">✕</span>
        </div>

        <div class="mod-label">
            <p>GENERAL:</p>
            <p>&nbsp (s) s: TOGGLE SIM</p>
            <p>&nbsp LArr: STEP ONE-SIM FRAME</p>
            <p>&nbsp UArr: SLOW MOTION</p>
            <p>&nbsp (b) R: RESET SCENE</p>

            <p>DEMO SCENES: </p>
            <p>&nbsp 1: PRATT TRUSS</p>
            <p>&nbsp 2: KING POST TRUSS</p>
            <p>&nbsp 3: LARGE BRIDGE</p>
            <p>&nbsp 4: CRANE</p>

            <p>Editor: </p>
            <p>&nbsp (s) i: TOGGLE</p>
            <p>&nbsp (b) I: SNAP TO GRID</p>
            <p>&nbsp (s) backspace: DELETE LATEST ENTITY</p>
            <p>&nbsp Objects:</p>
            <p>&nbsp &nbsp 1 --> 4: SPAWN MASS OBJECT</p>
            <p>&nbsp Force Generators: </p>
            <p>&nbsp &nbsp (s) k: SPRING JOINT</p>
            <p>&nbsp Constraints:</p>
            <p>&nbsp &nbsp (s) x: FIXED X</p>
            <p>&nbsp &nbsp (s) y: FIXED Y</p>
            <p>&nbsp &nbsp (s) p: FIXED POS</p>
            <p>&nbsp &nbsp (s) l: LINK</p>
            <p>&nbsp &nbsp (s) j: OFFSET LINK</p>
            <p>&nbsp &nbsp (s) t: FIXED ROTATION</p>
            <p>&nbsp &nbsp (s) m: FIXED OMEGA (motor)</p>
            <p>&nbsp Bezier Curve:</p>
            <p>&nbsp &nbsp (b) B: TOGGLE</p>
            <p>&nbsp &nbsp LEFT MOUSE + MOUSE POS: C-POINT POS</p>
            <p>&nbsp &nbsp (b) S: SPAWN MASS OBJECTS</p>

            <p>AUXILIARY BINDS:</p>
            <p>&nbsp LEFT MOUSE + MOUSE POS: MOUSE SPRING</p>
        </div>
    </div>

    <!-- SETTINGS -->
    <script>

        const start_values = {
            gravity: 8,
            linear_damping: 0.4,
            mouse_spring: 100,
            spring_joint: 100,
            omega_constraint: 90,
            lagrange_limit: 8,
        }

        const settings_close_btn = document.getElementById("settings-close-button");
        const settings_reset_btn = document.getElementById("settings-reset-button");
        const mod_settings_window = document.getElementById('mod-settings-window');

        mod_settings_window.style.display = "none";

        settings_close_btn.addEventListener('click', () => {
            mod_settings_window.style.display = 'none';
        });

        function setSlider(slider_id, value_id, value) {
            const _slider = document.getElementById(slider_id);
            _slider.value = value;

            const _value = document.getElementById(value_id);
            _value.innerHTML = value;
        }

        settings_reset_btn.addEventListener("click", () => {
            setSlider("settings-gravity-slider", "settings-gravity-value", start_values.gravity);
            setSlider("settings-linear-damping-slider", "settings-linear-damping-value", start_values.linear_damping);
            setSlider("settings-mouse-spring-slider", "settings-mouse-spring-value", start_values.mouse_spring);
            setSlider("settings-spring-joint-slider", "settings-spring-joint-value", start_values.spring_joint);
            setSlider("settings-omega-constraint-slider", "settings-omega-constraint-value", start_values.omega_constraint);
            setSlider("settings-lagrange-limit-slider", "settings-lagrange-limit-value", start_values.lagrange_limit);
        })

        document.addEventListener("keydown", (event) => {
            if (event.key == "q") {
                if (mod_settings_window.style.display == "block") {
                    mod_settings_window.style.display = "none";
                } else if (mod_settings_window.style.display == "none") {
                    mod_settings_window.style.display = "block";
                }
            }
        });

        const mod_settings_header = document.getElementById('mod-settings-header');
        let settings_dragging = false;
        let settings_off_x = 0, settings_off_y = 0;

        mod_settings_header.addEventListener('mousedown', (e) => {
            settings_dragging = true;
            settings_off_x = e.clientX - mod_settings_window.offsetLeft;
            settings_off_y = e.clientY - mod_settings_window.offsetTop;
        });

        document.addEventListener('mousemove', (e) => {
            if (settings_dragging) {
                mod_settings_window.style.left = `${e.clientX - settings_off_x}px`;
                mod_settings_window.style.top = `${e.clientY - settings_off_y}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            settings_dragging = false;
        });

        function updateSlider(slider_id, value_id) {
            const _slider = document.getElementById(slider_id);
            const _value = document.getElementById(value_id);
            _slider.addEventListener('input', () => {
                _value.innerText = parseFloat(_slider.value).toFixed(2);
            });
        }

        updateSlider("settings-gravity-slider", "settings-gravity-value");
        updateSlider("settings-linear-damping-slider", "settings-linear-damping-value");
        updateSlider("settings-mouse-spring-slider", "settings-mouse-spring-value");
        updateSlider("settings-spring-joint-slider", "settings-spring-joint-value");
        updateSlider("settings-omega-constraint-slider", "settings-omega-constraint-value");
        updateSlider("settings-lagrange-limit-slider", "settings-lagrange-limit-value");


    </script>

    <!-- PROFILING -->
    <script>
        const profiling_close_btn = document.getElementById("profiling-close-button");
        const mod_profiling_window = document.getElementById('profiling-window');

        mod_profiling_window.style.display = "none";

        profiling_close_btn.addEventListener('click', () => {
            mod_profiling_window.style.display = 'none';
        });

        function handleGraphToggleButton(btn_id, canv_id) {
            const btn = document.getElementById(btn_id);
            const canv = document.getElementById(canv_id);

            // btn.style.color = "#ffffff";
            canv.style.display = "none";

            btn.addEventListener("click", () => {
                if (canv.style.display == "none") {
                    canv.style.display = "flex";
                    btn.innerHTML = "-";
                } else if (canv.style.display == "flex") {
                    canv.style.display = "none";
                    btn.innerHTML = "+";
                }
            });
        }

        handleGraphToggleButton("system-dt-graph-toggle-button", "system-dt-graph-canvas");
        handleGraphToggleButton("system-pdt-graph-toggle-button", "system-pdt-graph-canvas");
        handleGraphToggleButton("system-rdt-graph-toggle-button", "system-rdt-graph-canvas");
        handleGraphToggleButton("system-cfsdt-graph-toggle-button", "system-cfsdt-graph-canvas");
        handleGraphToggleButton("system-energy-graph-toggle-button", "system-energy-graph-canvas");
        handleGraphToggleButton("system-c-eval-graph-toggle-button", "system-c-eval-graph-canvas");
        handleGraphToggleButton("system-c-dot-eval-graph-toggle-button", "system-c-dot-eval-graph-canvas");

        document.addEventListener("keydown", (event) => {
            if (event.key == "a") {
                if (mod_profiling_window.style.display == "block") {
                    mod_profiling_window.style.display = "none";
                } else if (mod_profiling_window.style.display == "none") {
                    mod_profiling_window.style.display = "block";
                }
            }
        });

        const mod_profiling_header = document.getElementById('mod-profiling-header');
        let profiling_dragging = false;
        let profiling_off_x = 0, profiling_off_y = 0;

        mod_profiling_header.addEventListener('mousedown', (e) => {
            profiling_dragging = true;
            profiling_off_x = e.clientX - mod_profiling_window.offsetLeft;
            profiling_off_y = e.clientY - mod_profiling_window.offsetTop;
        });

        document.addEventListener('mousemove', (e) => {
            if (profiling_dragging) {
                mod_profiling_window.style.left = `${e.clientX - profiling_off_x}px`;
                mod_profiling_window.style.top = `${e.clientY - profiling_off_y}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            profiling_dragging = false;
        });

    </script>

    <!-- INFO -->
    <script>
        const info_close_btn = document.getElementById("info-close-button");
        const mod_info_window = document.getElementById('info-window');

        mod_info_window.style.display = "none";

        info_close_btn.addEventListener('click', () => {
            mod_info_window.style.display = 'none';
        });

        document.addEventListener("keydown", (event) => {
            if (event.key == "z") {
                if (mod_info_window.style.display == "block") {
                    mod_info_window.style.display = "none";
                } else if (mod_info_window.style.display == "none") {
                    mod_info_window.style.display = "block";
                }
            }
        });

        const mod_info_header = document.getElementById('mod-info-header');
        let info_dragging = false;
        let info_off_x = 0, info_off_y = 0;

        mod_info_header.addEventListener('mousedown', (e) => {
            info_dragging = true;
            info_off_x = e.clientX - mod_info_window.offsetLeft;
            info_off_y = e.clientY - mod_info_window.offsetTop;
        });

        document.addEventListener('mousemove', (e) => {
            if (info_dragging) {
                mod_info_window.style.left = `${e.clientX - info_off_x}px`;
                mod_info_window.style.top = `${e.clientY - info_off_y}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            info_dragging = false;
        });

    </script>

    <!-- KEYBINDS -->
    <script>
        const keybinds_close_btn = document.getElementById("keybinds-close-button");
        const mod_keybinds_window = document.getElementById('keybinds-window');

        mod_keybinds_window.style.display = "none";

        keybinds_close_btn.addEventListener('click', () => {
            mod_keybinds_window.style.display = 'none';
        });

        document.addEventListener("keydown", (event) => {
            if (event.key == "w") {
                if (mod_keybinds_window.style.display == "block") {
                    mod_keybinds_window.style.display = "none";
                } else if (mod_keybinds_window.style.display == "none") {
                    mod_keybinds_window.style.display = "block";
                }
            }
        });

        const mod_keybinds_header = document.getElementById('mod-keybinds-header');
        let keybinds_dragging = false;
        let keybinds_off_x = 0, keybinds_off_y = 0;

        mod_keybinds_header.addEventListener('mousedown', (e) => {
            keybinds_dragging = true;
            keybinds_off_x = e.clientX - mod_keybinds_window.offsetLeft;
            keybinds_off_y = e.clientY - mod_keybinds_window.offsetTop;
        });

        document.addEventListener('mousemove', (e) => {
            if (keybinds_dragging) {
                mod_keybinds_window.style.left = `${e.clientX - keybinds_off_x}px`;
                mod_keybinds_window.style.top = `${e.clientY - keybinds_off_y}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            keybinds_dragging = false;
        });

    </script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js" integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <canvas id="engineCanvas" style="border: 1px solid white"></canvas>
    <script src="./main.js" type="module"></script>
</body>

</html>